-- #############################################################################
-- # Öğrenci Test Platformu - Veritabanı Kurulum Script'i
-- # Versiyon: 2.4 (Sınıf Hiyerarşisi Eklendi)
-- # Açıklama: Bu script, uygulamanın tüm veritabanı yapısını, güvenlik
-- #           kurallarını (RLS), fonksiyonlarını (RPC) ve tetikleyicilerini
-- #           oluşturur. Hiyerarşi "Sınıf > Ders > Ünite > Konu" şeklindedir.
-- # Önemli: Bu script, mevcut yapıları silip yeniden oluşturduğu için
-- #         güvenle tekrar çalıştırılabilir (idempotent).
-- #############################################################################


-- =============================================================================
-- BÖLÜM 1: TEMİZLİK (ESKİ YAPILARI GÜVENLİ BİR ŞEKİLDE KALDIRMA)
-- =============================================================================
-- Önce RLS politikalarını kaldır
DROP POLICY IF EXISTS "Adminler tüm profilleri görebilir ve güncelleyebilir" ON public.profiles;
DROP POLICY IF EXISTS "Kullanıcılar kendi profillerini görebilir ve güncelleyebilir" ON public.profiles;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.classes;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm sınıfları görebilir" ON public.classes;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.courses;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm dersleri görebilir" ON public.courses;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.units;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm üniteleri görebilir" ON public.units;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.topics;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm konuları görebilir" ON public.topics;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.tests;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm testleri görebilir" ON public.tests;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.questions;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm soruları görebilir" ON public.questions;
DROP POLICY IF EXISTS "Adminler tüm içeriklere erişebilir" ON public.options;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm seçenekleri görebilir" ON public.options;
DROP POLICY IF EXISTS "Adminler tüm test-soru ilişkilerine erişebilir" ON public.test_questions;
DROP POLICY IF EXISTS "Giriş yapmış kullanıcılar tüm test-soru ilişkilerini görebilir" ON public.test_questions;
DROP POLICY IF EXISTS "Adminler tüm denemeleri görebilir" ON public.test_attempts;
DROP POLICY IF EXISTS "Kullanıcılar kendi denemelerini görebilir" ON public.test_attempts;
DROP POLICY IF EXISTS "Kullanıcılar kendi denemelerini oluşturabilir" ON public.test_attempts;
DROP POLICY IF EXISTS "Adminler tüm cevapları görebilir" ON public.user_answers;
DROP POLICY IF EXISTS "Kullanıcılar kendi cevaplarını görebilir" ON public.user_answers;
DROP POLICY IF EXISTS "Kullanıcılar kendi cevaplarını oluşturabilir" ON public.user_answers;

-- Önce tetikleyiciyi kaldır
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- Sonra tabloları ve fonksiyonları kaldır (bağımlılık sırasına göre)
DROP TABLE IF EXISTS public.user_answers CASCADE;
DROP TABLE IF EXISTS public.test_attempts CASCADE;
DROP TABLE IF EXISTS public.options CASCADE;
DROP TABLE IF EXISTS public.test_questions CASCADE;
DROP TABLE IF EXISTS public.questions CASCADE;
DROP TABLE IF EXISTS public.tests CASCADE;
DROP TABLE IF EXISTS public.topics CASCADE;
DROP TABLE IF EXISTS public.units CASCADE;
DROP TABLE IF EXISTS public.courses CASCADE;
DROP TABLE IF EXISTS public.classes CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

DROP FUNCTION IF EXISTS public.get_user_role(uuid);
DROP FUNCTION IF EXISTS public.handle_new_user();
DROP FUNCTION IF EXISTS public.get_all_users();
DROP FUNCTION IF EXISTS public.delete_user_by_admin(uuid);
DROP FUNCTION IF EXISTS public.create_bulk_questions_with_options(bigint, jsonb);
DROP FUNCTION IF EXISTS public.create_question_in_bank(text, jsonb);
DROP FUNCTION IF EXISTS public.update_question_in_bank(bigint, text, jsonb);


-- =============================================================================
-- BÖLÜM 2: TABLOLARIN OLUŞTURULMASI
-- =============================================================================

-- Kullanıcı profilleri ve rolleri
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name text,
  role text NOT NULL DEFAULT 'user',
  created_at timestamptz NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.profiles IS 'Stores user profile information and roles.';

-- Sınıflar (En üst hiyerarşi)
CREATE TABLE public.classes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name text NOT NULL UNIQUE,
  created_at timestamptz NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.classes IS 'Grade levels, e.g., 9th Grade, 10th Grade.';

-- Dersler (Sınıflara bağlı)
CREATE TABLE public.courses (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  class_id bigint NOT NULL REFERENCES public.classes(id) ON DELETE CASCADE,
  name text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(class_id, name)
);
COMMENT ON TABLE public.courses IS 'Top-level course categories, e.g., Math, History.';

-- Üniteler (Derslere bağlı)
CREATE TABLE public.units (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  course_id bigint NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE,
  name text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(course_id, name)
);
COMMENT ON TABLE public.units IS 'Units within a course, e.g., "Basic Concepts" in Math.';

-- Konular (Ünitelere bağlı)
CREATE TABLE public.topics (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  unit_id bigint NOT NULL REFERENCES public.units(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(unit_id, name)
);
COMMENT ON TABLE public.topics IS 'Topics within a unit, e.g., "Numbers" in "Basic Concepts".';

-- Testler (Konulara bağlı)
CREATE TABLE public.tests (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  topic_id bigint NOT NULL REFERENCES public.topics(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(topic_id, name)
);
COMMENT ON TABLE public.tests IS 'Specific tests for a topic, e.g., "Rational Numbers Test".';

-- Sorular (Artık bir teste doğrudan bağlı değil, Soru Bankası)
CREATE TABLE public.questions (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  question_text text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.questions IS 'Central question bank. Questions are not tied to a single test.';

-- Test ve Sorular arasındaki Çok'a-Çok ilişki için ara tablo
CREATE TABLE public.test_questions (
  test_id bigint NOT NULL REFERENCES public.tests(id) ON DELETE CASCADE,
  question_id bigint NOT NULL REFERENCES public.questions(id) ON DELETE CASCADE,
  PRIMARY KEY (test_id, question_id)
);
COMMENT ON TABLE public.test_questions IS 'Junction table to link questions from the bank to specific tests.';

-- Seçenekler (Sorulara bağlı)
CREATE TABLE public.options (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  question_id bigint NOT NULL REFERENCES public.questions(id) ON DELETE CASCADE,
  option_text text NOT NULL,
  is_correct boolean NOT NULL DEFAULT false
);
COMMENT ON TABLE public.options IS 'Options for a question, with one marked as correct.';

-- Test Denemeleri
CREATE TABLE public.test_attempts (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  test_id bigint NOT NULL REFERENCES public.tests(id) ON DELETE CASCADE,
  score integer NOT NULL CHECK (score >= 0 AND score <= 100),
  created_at timestamptz NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.test_attempts IS 'Records each attempt a user makes on a test.';

-- Kullanıcı Cevapları
CREATE TABLE public.user_answers (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  attempt_id bigint NOT NULL REFERENCES public.test_attempts(id) ON DELETE CASCADE,
  question_id bigint NOT NULL REFERENCES public.questions(id) ON DELETE CASCADE,
  selected_option_id bigint NOT NULL REFERENCES public.options(id) ON DELETE CASCADE,
  is_correct boolean NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.user_answers IS 'Stores the specific answer a user gave for a question in an attempt.';


-- =============================================================================
-- BÖLÜM 3: FONKSİYONLAR VE TETİKLEYİCİLER
-- =============================================================================

-- Yardımcı fonksiyon: Kullanıcı rolünü getirme
CREATE OR REPLACE FUNCTION public.get_user_role(p_user_id uuid)
RETURNS text
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT role FROM public.profiles WHERE id = p_user_id;
$$;
COMMENT ON FUNCTION public.get_user_role(uuid) IS 'Helper to get a user''s role from their ID.';

-- Tetikleyici fonksiyonu: Yeni kullanıcı kaydolduğunda profiles tablosuna ekleme yapar
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name)
  VALUES (new.id, new.raw_user_meta_data->>'full_name');
  RETURN new;
END;
$$;
COMMENT ON FUNCTION public.handle_new_user() IS 'Trigger function to create a profile for a new user.';

-- Tetikleyici: auth.users tablosuna yeni kayıt eklendiğinde handle_new_user'ı çalıştırır
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- RPC: Toplu halde soru ve seçenek ekleme fonksiyonu (CSV Import için)
CREATE OR REPLACE FUNCTION public.create_bulk_questions_with_options(p_test_id bigint, p_questions jsonb)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    question_record jsonb;
    option_record jsonb;
    new_question_id bigint;
BEGIN
    IF (SELECT public.get_user_role(auth.uid())) <> 'admin' THEN
        RAISE EXCEPTION 'Bu işlemi sadece yöneticiler yapabilir.';
    END IF;

    FOR question_record IN SELECT * FROM jsonb_array_elements(p_questions)
    LOOP
        INSERT INTO public.questions (question_text)
        VALUES (question_record->>'question_text')
        RETURNING id INTO new_question_id;

        INSERT INTO public.test_questions (test_id, question_id)
        VALUES (p_test_id, new_question_id);

        FOR option_record IN SELECT * FROM jsonb_array_elements(question_record->'options')
        LOOP
            INSERT INTO public.options (question_id, option_text, is_correct)
            VALUES (new_question_id, option_record->>'option_text', (option_record->>'is_correct')::boolean);
        END LOOP;
    END LOOP;
END;
$$;
COMMENT ON FUNCTION public.create_bulk_questions_with_options(bigint, jsonb) IS 'RPC to bulk insert questions into the bank and associate them with a test. Admin only.';

-- RPC: Soru bankasına yeni bir soru ekleme
CREATE OR REPLACE FUNCTION public.create_question_in_bank(p_question_text text, p_options jsonb)
RETURNS bigint
LANGUAGE plpgsql
AS $$
DECLARE
    new_question_id bigint;
    option_record jsonb;
BEGIN
    IF (SELECT public.get_user_role(auth.uid())) <> 'admin' THEN
        RAISE EXCEPTION 'Bu işlemi sadece yöneticiler yapabilir.';
    END IF;

    INSERT INTO public.questions (question_text)
    VALUES (p_question_text)
    RETURNING id INTO new_question_id;

    FOR option_record IN SELECT * FROM jsonb_array_elements(p_options)
    LOOP
        INSERT INTO public.options (question_id, option_text, is_correct)
        VALUES (new_question_id, option_record->>'option_text', (option_record->>'is_correct')::boolean);
    END LOOP;
    
    RETURN new_question_id;
END;
$$;
COMMENT ON FUNCTION public.create_question_in_bank(text, jsonb) IS 'RPC to create a single question in the bank. Admin only.';


-- RPC: Soru bankasındaki bir soruyu güncelleme
CREATE OR REPLACE FUNCTION public.update_question_in_bank(p_question_id bigint, p_question_text text, p_options jsonb)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    option_record jsonb;
BEGIN
    IF (SELECT public.get_user_role(auth.uid())) <> 'admin' THEN
        RAISE EXCEPTION 'Bu işlemi sadece yöneticiler yapabilir.';
    END IF;

    -- Soru metnini güncelle
    UPDATE public.questions
    SET question_text = p_question_text
    WHERE id = p_question_id;

    -- Eski seçenekleri sil
    DELETE FROM public.options WHERE question_id = p_question_id;

    -- Yeni seçenekleri ekle
    FOR option_record IN SELECT * FROM jsonb_array_elements(p_options)
    LOOP
        INSERT INTO public.options (question_id, option_text, is_correct)
        VALUES (p_question_id, option_record->>'option_text', (option_record->>'is_correct')::boolean);
    END LOOP;
END;
$$;
COMMENT ON FUNCTION public.update_question_in_bank(bigint, text, jsonb) IS 'RPC to update a single question in the bank. Admin only.';


-- RPC: Tüm kullanıcıları listeleme (Admin paneli için)
CREATE OR REPLACE FUNCTION public.get_all_users()
RETURNS TABLE (
    id uuid,
    full_name text,
    email text,
    role text,
    created_at timestamptz
)
LANGUAGE sql
SECURITY DEFINER
AS $$
    -- Sadece adminlerin bu fonksiyonu kullanabilmesini sağla
    -- Fonksiyonun en başında kontrol eklemek daha güvenlidir.
    SELECT * FROM (SELECT null::uuid, null::text, null::text, null::text, null::timestamptz) AS t WHERE (SELECT public.get_user_role(auth.uid())) <> 'admin' LIMIT 0;

    -- Eğer kullanıcı admin ise, asıl sorguyu çalıştır
    SELECT p.id, p.full_name, u.email, p.role, u.created_at
    FROM public.profiles p
    JOIN auth.users u ON p.id = u.id;
$$;
COMMENT ON FUNCTION public.get_all_users() IS 'RPC for admins to get a list of all users.';


-- RPC: Bir kullanıcıyı silme (Admin paneli için)
CREATE OR REPLACE FUNCTION public.delete_user_by_admin(user_id_to_delete uuid)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Sadece adminlerin bu fonksiyonu kullanabilmesini sağla
    IF (SELECT public.get_user_role(auth.uid())) <> 'admin' THEN
        RAISE EXCEPTION 'Bu işlemi sadece yöneticiler yapabilir.';
    END IF;

    -- Silinecek kullanıcının kendisi olmamasını kontrol et
    IF auth.uid() = user_id_to_delete THEN
        RAISE EXCEPTION 'Yöneticiler kendi hesabını silemez.';
    END IF;

    -- auth.admin_delete_user fonksiyonunu kullanarak kullanıcıyı tamamen sil
    PERFORM auth.admin_delete_user(user_id_to_delete);
END;
$$;
COMMENT ON FUNCTION public.delete_user_by_admin(uuid) IS 'RPC for admins to permanently delete a user.';


-- =============================================================================
-- BÖLÜM 4: SATIR SEVİYESİ GÜVENLİK (ROW LEVEL SECURITY - RLS)
-- =============================================================================

-- Tüm tablolarda RLS'yi aktif et
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.units ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.topics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.test_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.options ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.test_attempts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_answers ENABLE ROW LEVEL SECURITY;

-- `profiles` tablosu için politikalar
CREATE POLICY "Adminler tüm profilleri görebilir ve güncelleyebilir" ON public.profiles
FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Kullanıcılar kendi profillerini görebilir ve güncelleyebilir" ON public.profiles
FOR ALL USING (auth.uid() = id) WITH CHECK (auth.uid() = id);

-- İçerik tabloları (`classes`, `courses`, `units`, `topics`, `tests`, `questions`, `options`, `test_questions`) için politikalar
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.classes FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm sınıfları görebilir" ON public.classes FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.courses FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm dersleri görebilir" ON public.courses FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.units FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm üniteleri görebilir" ON public.units FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.topics FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm konuları görebilir" ON public.topics FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.tests FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm testleri görebilir" ON public.tests FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.questions FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm soruları görebilir" ON public.questions FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm içeriklere erişebilir" ON public.options FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm seçenekleri görebilir" ON public.options FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Adminler tüm test-soru ilişkilerine erişebilir" ON public.test_questions FOR ALL USING (public.get_user_role(auth.uid()) = 'admin') WITH CHECK (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Giriş yapmış kullanıcılar tüm test-soru ilişkilerini görebilir" ON public.test_questions FOR SELECT USING (auth.role() = 'authenticated');


-- `test_attempts` tablosu için politikalar
CREATE POLICY "Adminler tüm denemeleri görebilir" ON public.test_attempts FOR SELECT USING (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Kullanıcılar kendi denemelerini görebilir" ON public.test_attempts FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Kullanıcılar kendi denemelerini oluşturabilir" ON public.test_attempts FOR INSERT WITH CHECK (auth.uid() = user_id);

-- `user_answers` tablosu için politikalar
CREATE POLICY "Adminler tüm cevapları görebilir" ON public.user_answers FOR SELECT USING (public.get_user_role(auth.uid()) = 'admin');
CREATE POLICY "Kullanıcılar kendi cevaplarını görebilir" ON public.user_answers FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.test_attempts
    WHERE test_attempts.id = user_answers.attempt_id AND test_attempts.user_id = auth.uid()
  )
);
CREATE POLICY "Kullanıcılar kendi cevaplarını oluşturabilir" ON public.user_answers FOR INSERT WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.test_attempts
    WHERE test_attempts.id = user_answers.attempt_id AND test_attempts.user_id = auth.uid()
  )
);


-- =============================================================================
-- BÖLÜM 5: ÖRNEK VERİLER (YENİ MİMARİYE UYGUN)
-- =============================================================================
DO $$
DECLARE
  sinif_9_id bigint;
  tarih_course_id bigint;
  osmanli_unit_id bigint;
  yukselme_topic_id bigint;
  fsm_test_id bigint;
  q1_id bigint;
  q2_id bigint;
  q3_id bigint;
BEGIN
  -- Hiyerarşiyi oluştur
  INSERT INTO public.classes (name) VALUES ('9. Sınıf') RETURNING id INTO sinif_9_id;
  INSERT INTO public.courses (class_id, name) VALUES (sinif_9_id, 'Tarih') RETURNING id INTO tarih_course_id;
  INSERT INTO public.units (course_id, name) VALUES (tarih_course_id, 'Osmanlı İmparatorluğu') RETURNING id INTO osmanli_unit_id;
  INSERT INTO public.topics (unit_id, name, description) VALUES (osmanli_unit_id, 'Yükselme Dönemi', 'Osmanlı İmparatorluğu''nun en parlak dönemi.') RETURNING id INTO yukselme_topic_id;
  INSERT INTO public.tests (topic_id, name, description) VALUES (yukselme_topic_id, 'Fatih Sultan Mehmet Dönemi Testi', 'Fatih Sultan Mehmet dönemi ile ilgili temel bilgileri ölçer.') RETURNING id INTO fsm_test_id;

  -- Soruları Soru Bankası'na ekle
  -- Soru 1
  INSERT INTO public.questions (question_text) VALUES ('İstanbul kaç yılında fethedilmiştir?') RETURNING id INTO q1_id;
  INSERT INTO public.options (question_id, option_text, is_correct) VALUES
    (q1_id, '1451', false),
    (q1_id, '1453', true),
    (q1_id, '1461', false),
    (q1_id, '1481', false);

  -- Soru 2
  INSERT INTO public.questions (question_text) VALUES ('Fatih Sultan Mehmet''in babası kimdir?') RETURNING id INTO q2_id;
  INSERT INTO public.options (question_id, option_text, is_correct) VALUES
    (q2_id, 'I. Murat', false),
    (q2_id, 'Yıldırım Bayezid', false),
    (q2_id, 'II. Murat', true),
    (q2_id, 'II. Bayezid', false);

  -- Soru 3
  INSERT INTO public.questions (question_text) VALUES ('Aşağıdaki olaylardan hangisi Fatih Sultan Mehmet döneminde gerçekleşmemiştir?') RETURNING id INTO q3_id;
  INSERT INTO public.options (question_id, option_text, is_correct) VALUES
    (q3_id, 'Otlukbeli Savaşı', false),
    (q3_id, 'Trabzon İmparatorluğu''nun fethi', false),
    (q3_id, 'Belgrad''ın Fethi', true),
    (q3_id, 'Kırım Hanlığı''nın Osmanlı''ya bağlanması', false);

  -- Soruları teste bağla
  INSERT INTO public.test_questions (test_id, question_id) VALUES
    (fsm_test_id, q1_id),
    (fsm_test_id, q2_id),
    (fsm_test_id, q3_id);

END $$;

-- =============================================================================
-- KURULUM TAMAMLANDI
-- =============================================================================